import { GoogleGenAI, Type } from "@google/genai";
import { GenerateParams, CopyResult, ToneType } from "../types";

const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });

export const generateCrazyThursdayCopy = async (params: GenerateParams): Promise<CopyResult> => {
  const { tone, keywords } = params;

  const backgroundPlot = `
    燕云十六声——剧情梗概及世界观

    故事背景与世界观
    
    游戏以五代十国末期至北宋初年（约10世纪）为背景。这是一段介于盛唐和盛宋之间的乱世，也是多元文化交融的时代。开发者解释，“燕云十六声”一名取自后周王朴定律时将十二律加四清声的故事，用以比喻中华大地多元包容的人文；而“燕云十六州”则是历史上辽宋边境的十六个州，以此暗示游戏背景中的民族冲突与权力博弈 ￼。官方强调本作虽然基于真实时代，但会有适度改编 ￼，因此将传统历史事件融入武侠幻想。
    
    在世界观上，剧情发生在中原与漠北、江南等交界的动乱时期。故事开端“渡桥之战”刚刚结束 ￼，暗示后周柴荣与契丹等势力的冲突。契丹（辽国）与汉人政权对抗的影子始终笼罩其间：游戏中出现契丹使臣被刺杀的暗线，以及绣金楼为此事发兵清河的情节 ￼。游戏还涉及赵宋内部的权力更替与忠诚问题，例如开封篇章中的“强宋有我”（赵大赵二父子故事）就映射出忠于宋室的理念 ￼。此外，官兵、匪盗、教头、侠客、商帮等众多势力在江湖中角力，形成了错综复杂的家国命题和价值选择。总体而言，宏大的时代背景与真实历史相互交织，为游戏主线和支线的发生提供了驱动力。
    
    主线剧情梗概
    
    游戏剧情始于青河——一片平静祥和的故乡 ￼。主人公自幼被养母韩姨和养父江叔抚养长大，他们象征着家的归属与温暖，也是主人公步入江湖的启蒙来源 ￼。在一次当地祭典上，一名神秘人趁乱盗走了主人公身上佩戴的玉坠 ￼。这一事件揭开序幕：主人公由此卷入一场比个人命运更大的阴谋。从“活人医馆”暗藏的秘密开始，一点点揭开埋藏在家乡之下的谜团 ￼ ￼。
    
    三年前的交桥之战中，十九岁的江叔江晏带着襁褓中的主人公和武林至宝“镇冠珏”逃出绣金楼与契丹的重围，隐居青河 ￼。十三年后，江晏受魏道济之托赴南唐救援田英并失踪三年；三年后（即游戏开篇），他突然蒙面归来，身着绣金楼装束，将“镇冠珏”从主人公身上夺走 ￼ ￼。此时，反派绣金楼联络契丹势力，三路兵分青河：一路直指韩姨（因她掌握契丹卧底名单）、一路追捕田英（因其刺杀契丹使者）、一路寻找“镇冠珏”或主人公本人——这正是游戏主线所在 ￼。与之对峙，刀哥和褚清泉（韩姨旧识）千里驰援青河，守护江晏的“秘密” ￼。然而，在预备出发的前夜，绣金楼司令千夜来袭，阵法大火焚烧开坛楼，刀哥和战友红线为掩护主人公壮烈牺牲 ￼。主角侥幸逃脱，自此踏上复仇与寻真之路。
    
    离开青河后，剧情转战开封等地。开封篇章中，主人公参与了“侠义会”，并得知传说中的神器“炼金之器”——一件据称能炼金的奇物，却可能蕴藏黑暗阴谋 ￼。原本寻宝之旅逐渐演变为与历史势力交织的斗争，玩家要在开封的暗巷和秘境中揭示真相 ￼。剧情还穿插了碎片化线索——从路边乞丐的话语、尘封手册的文字，到古墓遗迹中的遗物，逐步拼凑出主角身世之谜与朝廷阴谋 ￼ ￼。在目前曝光的剧情中，玩家终将迎来与幕后操盘手“南竹”的决战——这位长期隐藏在暗处的神秘人物将在一场文字陷阱与刀锋杀机并存的较量中浮出水面 ￼。至此，主线故事将真相与命运交织，让玩家从个人恩怨提升到群雄争锋的武侠史诗。
    
    关键角色及其动机
    \t•\t主人公（玩家扮演，少东家(少冬瓜)）：一位从小被寒姨和江叔抚养的少年剑客。身世成谜，与镇冠珏等秘密紧密相连。他渴望踏上江湖，寻回失落的真相和亲情（如失窃的玉坠）。
    \t•\t江叔江晏：主角的义父，年轻时曾在渡桥之战中保护幼子逃难。其随身携带的武林至宝“镇冠珏”被契丹与绣金楼追捕。十三年后归来，夺走主角的镇冠珏。他的动机暂不得而知，但“江晏的秘密”显然关乎整个阴谋。
    \t•\t寒姨韩姨：主角的养母，性格坚韧。她持有契丹卧底名单，因此成为绣金楼的头号目标。被迫筹备逃亡，最终在出发前夜面对绣金楼伏击。她的目标是保护养子并揭露敌人秘密。
    \t•\t刀哥与红线：慕名江叔重义的侠士。他们得知绣金楼来犯青河的计划后迅速赶来，誓死守护江叔和主角。但在火烧开坛楼时，二人同生共死，为掩护主角突围英勇牺牲 ￼。
    \t•\t田英：河西武士，曾刺杀契丹使臣。他成为绣金楼通缉的对象之一。玩家在清河遭遇的第二路围剿正是为讨伐他而来。他的信念与目的将影响国家间的恩怨。
    \t•\t绣金楼：主要反派势力，暗中受契丹指使。此番入侵青河就是替契丹报仇和夺取镇冠珏之举。绣金楼阴险狡诈，其领袖千夜心狠手辣，意图颠覆正道。
    \t•\t南竹：神秘幕后人物，长期隐身操纵局势。他表面正义低调，实则手段狠辣。玩家在后期将与南竹正面对决，那是一场充满诡计和杀机的智慧对决 ￼。
    \t•\t赵氏父子（“赵大赵二”）：开封城中的人物，身处宋朝初立的时代冲突中。“强宋有我”故事线暗示他们对宋室的忠诚。他们代表了乱世中的家国情怀——为了宋朝可以不惜牺牲个人利益。
    \t•\t其他势力/角色：开封民间有围绕“金叶子”秘密的故事线 ￼；河西、凉州等地也各有门派侠侣、庄园公会等，玩家可以结识并影响他们的命运。这些角色都有各自动机（保家卫国、追求自由或复仇），他们的选择与主角命运息息相关。
    
    玩家角色及抉择
    
    玩家扮演的主角是一位年轻剑客，他渴望通过江湖历练揭示身世之谜。官方描述中指出，“动荡的十世纪中国，你将化身为一名年轻的剑客，揭开被遗忘的真相与自身身世的谜团” ￼。游戏强调玩家的自由度和选择重要性：在浩瀚江湖中，玩家可以随意探访各地、挑战名宿，也可自由决定个人角色定位 ￼ ￼。每个抉择都有实质影响——正如官方所言，“在这动荡时代，你的每个选择都有其分量：是成为引发混乱的使者，面对追捕与入狱；还是结交乡民、建立联盟，成为武侠世界的英雄？” ￼。在开封城内，超过一万名NPC各有动机，玩家与他们比武、交易、结交时，NPC会根据你的行为改变态度 ￼。游戏还允许玩家加入或创建公会、参与阵营战争 ￼，在个人成长的同时影响江湖格局。这些机制凸显：主角既是个人成长的剑客，也是乱世中抉择家国的大写志士。
    
    势力对抗、历史冲突与家国命题
    
    《燕云十六声》的剧情交织着家国与民族的宏大主题。五代十国的“燕云十六州”本是北宋与契丹交锋的边疆地区 ￼。游戏中，契丹势力通过暗线（如田英刺使事）与汉人政权冲突不止 ￼；南北对峙的阴影下，小国或门派各怀异志。主人公所在的宋朝势力（以“强宋有我”为代表 ￼）象征着统一与家国情怀，而对立的后周余力或契丹爪牙则代表旧秩序与割据。玩家在青河之战后亲历的村落倘徉、武学传承和对敌进攻，都反映了民族冲突的历史浪潮 ￼ ￼。在开封，百姓视角的“一叶平生”剧情以“金叶子”之秘揭示民间历史观 ￼，而庙堂上的决策则牵动整个王朝的存亡。无论是潇洒逍遥的侠客，还是忠勇爱国的志士，亦或是布衣江湖的隐士，他们各自的选择与命运最终都指向“家国”这一命题。通过各方势力的对抗与人物抉择，游戏向玩家呈现了一个动荡时代的全景：个人情怀与大义宏愿共存，在千年的历史洪流中铸造属于自己的侠义传奇 ￼ ￼。
  `;

  const referenceCase = `
    今天是2025年7月3日，是2025年的第183天，是2025年刚好过了一半的日子。从今天开始，比起2000年，我们更接近2050年。我们站在历史的对称轴上，左手是拨号上网的童年，右手是脑机接口的未来。这是时间的更迭，文明的跃迁。如此重要的日子，应当以最庄重的方式纪念。恰逢肯德基疯狂星期四，谁v我50？让我买个黄金脆皮鸡，在咀嚼酥脆的瞬间，感受时光的流逝，顺便思考下炸鸡技术在2000-2025这1/4世纪里的进化史。
    
    怀孕三个月老公暴露本性对我进行家暴，恶婆婆对我冷嘲热讽。闺蜜背叛我跟老公勾搭上，我的忍让换来的只有得寸进尺，我决定不再忍下去!只需要微我五十即可聆听我的复仇计划!
    
    同事欺我，老板骂我，顾客打我，我流浪在街头，衣衫褴褛，身无分文，活的不如一条狗。天地浩大，却没有我的容身之处。我想问一问苍天，今天的肯德基疯狂星期四，谁请我吃!
    
    老大，我们每周四这样装傻充愣的复制粘贴，真的能吃到肯德基吗？
  `

  const tonePromptMap: Record<ToneType, string> = {
    [ToneType.HEROIC]: "笔触硬朗，如刀劈斧凿。重在侠义与决绝。",
    [ToneType.MELANCHOLIC]: "笔触苍凉，如晚秋冷雨。重在孤独与漂泊。",
    [ToneType.MYSTERIOUS]: "笔触隐晦，如雾里看花。重在未知的恐惧与寒意。",
    [ToneType.HUMOROUS]: "笔触如市井泼皮，看似正经实则荒诞。",
  };

  // Generate a random scenario hint to force diversity
  const prompt = `
    背景预设：${backgroundPlot}
    
    --------------------------------
    
    参考范文：${referenceCase}
    
    --------------------------------
    
    请以主人公（少冬瓜）为第一视角创作一篇“肯德基疯狂星期四”的文案。
    
    核心要求：
    1. **沉浸式剧情**：
       - 结合“梗”。
       - 文风要狠、要冷、要简练。
    2. **字数限制**：全文字数严格控制在50-200字之间。
    3. **内容禁忌**：正文中**绝不出现**“燕云十六声”游戏名。
    4. **极度反转**：
       - 最后突然转折，V我50，肯德基疯狂星期四。(且听我如何复仇
    5. **关键词融入**：${keywords || '随机生成'}。
    6. **风格设定**：${tonePromptMap[tone]}。
    
    输出格式要求：
    请返回JSON格式，包含两个字段：
    - title: 文案的简短古风标题 (例如：断刀行)
    - content: 文案的正文内容
  `;

  try {
    const response = await ai.models.generateContent({
      model: "gemini-2.5-flash",
      contents: prompt,
      config: {
        responseMimeType: "application/json",
        responseSchema: {
          type: Type.OBJECT,
          properties: {
            title: { type: Type.STRING },
            content: { type: Type.STRING },
          },
          required: ["title", "content"],
        },
        temperature: 1.4, // Increased for high creativity/randomness
        topP: 0.95,
        topK: 64,
        seed: Math.floor(Math.random() * 10000000), // Add random seed to ensure variations
      },
    });

    const text = response.text;
    if (!text) {
      throw new Error("No content generated.");
    }

    return JSON.parse(text) as CopyResult;
  } catch (error) {
    console.error("Error generating copy:", error);
    throw new Error("文案生成失败，请稍后重试。或许是江湖风浪太大，信号不好。");
  }
};
